# メッセージ認証コード(Message Authentication Code)について
 - 正真性(完全性)の確認と認証を行う技術
 - "鍵に依存した一方高ハッシュ関数"

# メッセージ認証コードの実現方法
 - 一方高ハッシュ関数を利用して実現 -> HMAC
 - ブロック暗号を使って実現 -> AES-CMAC
   CBCモードの最終ブロックをMAC値として使用する. IV(Initial Vector)は0固定.
   CBC-MACはメッセージとMAC値のペアから別のメッセージとMAC値を生成する攻撃が見つかっている

# 伸長攻撃(length extension attack)
MAC値をH(k, m) := H(k||m)とした時に可能な攻撃方法

メッセージ: m
鍵: k
MAC関数: H
メッセージの連結: ||
反復型ハッシュの圧縮関数: f

攻撃者が知っているもの: メッセージm,MAC関数,MAC値

ここで、ハッシュの最終ブロックはm_nはk||mの最後の部分にパディングpをつけたもの

```
+-----+--------------+---+
|  k  |       m      | p |
+-----+--------------+---+
pの最大長はハッシュ関数のブロック長-1
```
反復型ハッシュ関数(SHA1, SHA2など)の場合、最終的なハッシュ値はm_nと一つ前の圧縮関数の出力h_n-1をあっゆく関数fに与えた結果である。
```
 h = H(k||m) = f(h_n-1, m_n)
```

攻撃者はmを知っているので, m' = m || p || c という任意のメッセージcを追加した新たなメッセージ m'を作成できる。さらにm'から正当なMAC値も計算できる
```
H(k, m) = H(k||m||p||c) = f(h, cにパディングしたもの)
```
したがって、MACの共通鍵を知らなくてもMAC値を計算できてしまう。仮に、H(m||k)では身長攻撃はできないが他の攻撃ができることが証明されている。

# 認証付き暗号
認証付き暗号(AEやAEAD)は、対象暗号とメッセージ認証コードを組み合わせて機密性・正真性・認証を同時に満たす仕組み。

 - Encrypt-then-MAC 平文 -> 暗号化 -> MAC値計算
 - Encrypt-and-MAC  平文 -> 暗号化 & 平文 -> MAC値計算
 - MAC-then-Encrypt 平文 -> MAC値計算 then (平文+MAC値) -> 暗号化

## GCM / GMAC
GCMは認証付き暗号の一種である。GMACはGCMを認証コード専用として用いたものを差す。


## HMAC
ハッシュ関数を使ったMACの一種。ハッシュ関数はMD5, SHA256等任意の関数を使うことができ、それぞれHMAC-MD5, HMAC-SHA256と呼ばれる。HMACの計算式は以下のようになる。
```
HMAC(K, M) = H((K' ^ opad) || H((K' ^ ipad) || M))
```

K: 共通鍵 (バイト長: Lバイト)
H: ハッシュ関数 (ブロックサイズ長: Bバイト)
K':
  K || 000...0 (0はB-Lバイト) (L < B))
  H(K)                       (L > B)
opad: 0x5c x Bバイト
ipad: 0x36 x Bバイト

